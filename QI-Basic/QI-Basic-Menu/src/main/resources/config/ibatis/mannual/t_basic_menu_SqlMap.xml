<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="t_basic_menu">

    <resultMap id="PaginationMap" extends="ibatorgenerated_BaseResultMap" class="com.qi.menu.web.model.vo.MenuVO">
        <result column="Domain" property="domain" jdbcType="VARCHAR"/>
    </resultMap>

    <resultMap id="parentMap" extends="ibatorgenerated_BaseResultMap" class="com.qi.menu.web.model.vo.MenuVO"
               groupBy="guid">
        <!-- WARNING - This element is automatically generated by Apache iBATIS
            ibator, do not modify. This element was generated on Wed Jan 06 20:05:29
            CST 2016. -->
        <result column="Domain" property="domain" jdbcType="VARCHAR"/>
        <result property="children" resultMap="t_basic_menu.childrenMap"/>
    </resultMap>

    <resultMap id="childrenMap" class="com.qi.menu.web.model.vo.MenuVO">
        <!-- WARNING - This element is automatically generated by Apache iBATIS
            ibator, do not modify. This element was generated on Wed Jan 06 20:05:29
            CST 2016. -->
        <result column="cGuid" property="guid" jdbcType="BIGINT"/>
        <result column="cParentID" property="parentid" jdbcType="BIGINT"/>
        <result column="cParentName" property="parentname" jdbcType="VARCHAR"/>
        <result column="cMenuCode" property="menucode" jdbcType="VARCHAR"/>
        <result column="cMenuName" property="menuname" jdbcType="VARCHAR"/>
        <result column="cContextPath" property="contextpath" jdbcType="VARCHAR"/>
        <result column="cController" property="controller" jdbcType="VARCHAR"/>
        <result column="cRequestMapping" property="requestmapping" jdbcType="VARCHAR"/>
        <result column="cIconPath" property="iconpath" jdbcType="VARCHAR"/>
        <result column="cDescription" property="description" jdbcType="VARCHAR"/>
        <result column="cRootID" property="rootid" jdbcType="BIGINT"/>
        <result column="cLevel" property="level" jdbcType="INTEGER"/>
        <result column="cSort" property="sort" jdbcType="INTEGER"/>
        <result column="cIsLeaf" property="isleaf" jdbcType="BIT"/>
        <result column="cStatus" property="status" jdbcType="BIT"/>
    </resultMap>

    <select id="findBasicMenuByAuthority" parameterClass="java.util.Map" resultMap="parentMap">
        SELECT
        pm.*,
        pr.Domain AS Domain,
        cm.Guid AS cGuid,
        cm.ParentID AS cParentID,
        cm.ParentName AS cParentName,
        cm.MenuCode AS cMenuCode,
        cm.MenuName AS cMenuName,
        cm.ContextPath AS cContextPath,
        cm.Controller AS cController,
        cm.RequestMapping AS cRequestMapping,
        cm.IconPath AS cIconPath,
        cm.Description AS cDescription,
        cm.RootID AS cRootID,
        cm.`Level` AS cLevel,
        cm.Sort AS cSort,
        cm.IsLeaf AS cIsLeaf,
        cm.`Status` AS cStatus
        FROM
        t_basic_menu pm
        LEFT JOIN t_basic_system_registry pr ON pm.SystemCode = pr.Code
        LEFT JOIN t_basic_menu cm ON pm.Guid = cm.ParentID
        <dynamic prepend="where">
            <isNotEmpty property="ParentID" prepend="and">
                pm.ParentID = #ParentID#
            </isNotEmpty>
            <isNotEmpty property="SystemCode" prepend="and">
                pm.SystemCode = #SystemCode#
            </isNotEmpty>
            <isNotEmpty property="status" prepend="and">
                pm.status = #status#
            </isNotEmpty>
        </dynamic>
        ORDER BY cm.Sort ASC, pm.Sort ASC
    </select>

    <sql id="MENU.count_template">
        <![CDATA[
        SELECT COUNT(*)
        ]]>
    </sql>

    <sql id="MENU.field_template">
        <![CDATA[
        SELECT
            pm.Guid,
            pm.ParentID,
            pm.ParentName,
            pm.SystemCode,
            pm.MenuCode,
            pm.MenuName,
            pm.ContextPath,
            pm.Controller,
            pm.RequestMapping,
            pm.IconPath,
            pm.Description,
            pm.RootID,
            pm.LEVEL,
            pm.Sort,
            pm.IsLeaf,
            pm.STATUS,
            pr.Domain      AS Domain
        ]]>
    </sql>

    <sql id="MENU.where_template">
        <dynamic prepend="where">
            <isNotEmpty property="param.parentid" prepend="and">
                pm.ParentID = #param.parentid#
            </isNotEmpty>
            <isNotEmpty property="param.status" prepend="and">
                pm.STATUS = #param.status#
            </isNotEmpty>
            <isNotEmpty property="param.level" prepend="and">
                pm.LEVEL = #param.level#
            </isNotEmpty>
            <isNotEmpty property="param.systemcode" prepend="and">
                pm.SystemCode = #param.systemcode#
            </isNotEmpty>
            <isNotEmpty property="fullText" prepend="and">
                CONCAT(
                pm.MenuCode,
                pm.MenuName,
                pr.Domain,
                pm.ContextPath,
                pm.Controller,
                pm.RequestMapping
                ) LIKE concat('%',#fullText#,'%')
            </isNotEmpty>
        </dynamic>
    </sql>

    <select id="countByPagination" parameterClass="com.qi.common.model.model.PagingModel"
            resultClass="java.lang.Integer">
        <include refid="MENU.count_template"/>
        FROM
        t_basic_menu pm
        LEFT JOIN t_basic_system_registry pr ON pm.SystemCode = pr.code
        <include refid="MENU.where_template"/>
    </select>

    <select id="queryByPagination" parameterClass="com.qi.common.model.model.PagingModel"
            resultMap="PaginationMap">
        <include refid="MYSQL.paginationStart"/>
        <include refid="MENU.field_template"/>
        FROM
        t_basic_menu pm
        LEFT JOIN t_basic_system_registry pr ON pm.SystemCode = pr.code
        <include refid="MENU.where_template"/>
        <isNotNull property="orderByClause">
            order by $orderByClause$
        </isNotNull>
        <include refid="MYSQL.paginationEnd"/>
    </select>
</sqlMap>